<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Xewee Mini-App</title>
    
    <!-- Telegram WebApp Script (ESSENTIAL) -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <!-- Google Fonts for pixel-art style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
    
    <!-- Embedded CSS Styling -->
    <style>
        /* Telegram Theme Colors (dynamic) and Custom Xewee Colors */
        :root {
            --tg-bg: var(--tg-theme-bg-color, #212121);
            --tg-text: var(--tg-theme-text-color, #eeeeee);
            --tg-hint: var(--tg-theme-hint-color, #9e9e9e);
            --tg-button: var(--tg-theme-button-color, #42a5f5);
            --tg-button-text: var(--tg-theme-button-text-color, #ffffff);
            --tg-secondary-bg: var(--tg-theme-secondary-bg-color, #303030);
            
            --pixel-border-light: #424242; /* Lighter pixel border shade */
            --pixel-border-dark: #000000; /* Darker pixel border shade */
            --accent-green: #00e676; /* Success/Approved */
            --accent-red: #ff5252; /* Danger/Rejected */
            --accent-yellow: #ffea00; /* Balance/Pending */
            --pixel-input-bg: #ffffff; /* White background for the special input */
            --pixel-input-text: #000000; /* Dark text for the special input */
            --notification-success-bg: #004d40; /* Dark green for approved notifications */
            --notification-danger-bg: #b71c1c; /* Dark red for rejected notifications */
            --notification-info-bg: #1a237e; /* Dark blue for general info (e.g., invites, gifts) */
            --notification-text-color: #ffffff; /* White text for notifications */
            --notification-badge-bg: #ff0000; /* Red badge for unread notifications */
            --notification-badge-text: #ffffff;
            
            /* Game Specific Colors */
            --game-player-color: var(--accent-green);
            --game-opponent-color: var(--accent-red);
            --game-waiting-color: var(--accent-yellow);
        }
        
        /* Keyframe Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes toastIn { from { opacity: 0; bottom: 60px; } to { opacity: 1; bottom: 80px; } }
        @keyframes toastOut { to { opacity: 0; bottom: 60px; } }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Base Body Styles */
        body { 
            font-family: 'VT323', monospace; 
            padding: 10px 10px 80px 10px; /* Padding for content and bottom nav */
            margin: 0; 
            color: var(--tg-text); 
            background-color: var(--tg-bg); 
            -webkit-font-smoothing: none; /* Crucial for pixelated text effect */
            image-rendering: pixelated; /* Ensures all images/graphics stay pixelated */
            animation: fadeIn 0.5s; 
            overflow-x: hidden; /* Prevent horizontal scroll */
            box-sizing: border-box; /* Include padding in element's total width/height */
        }
        
        /* View Management */
        .app-view { display: none; } /* Hide all views by default */
        .app-view.active { display: block; animation: fadeIn 0.3s; } /* Show active view with fade */
        
        /* Pixel-Art Container Styling */
        .pixel-container { 
            border: 3px solid var(--pixel-border-dark); 
            border-right-color: var(--pixel-border-light); 
            border-bottom-color: var(--pixel-border-light); 
            background: var(--tg-secondary-bg); 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.1); /* Subtle inner shadow for depth */
        }
        
        /* Header Styling */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 5px 0; 
            border-bottom: 2px solid var(--pixel-border-light); /* Separator */
            margin-left: -10px; /* Adjust for body padding */
            margin-right: -10px; /* Adjust for body padding */
            padding-left: 10px;
            padding-right: 10px;
        }
        .header .app-title-tagline {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .header .app-title-tagline h1 { 
            font-size: 28px; 
            margin: 0; 
            margin-bottom: 2px; /* Reduced space below title */
            color: var(--tg-text);
        } 
        .header .app-title-tagline p { 
            font-size: 16px; /* Slightly smaller for tagline */
            color: var(--tg-hint); 
            margin: 0; 
        }

        .header .top-right-nav {
            display: flex;
            gap: 15px; 
            align-items: center;
        }
        .header-icon-button {
            background: none;
            border: none;
            color: var(--tg-text);
            font-family: 'VT323', monospace; 
            font-size: 24px; 
            cursor: pointer;
            padding: 5px; 
            position: relative; 
            filter: drop-shadow(0 0 2px var(--tg-text)); 
            transition: all 0.1s ease-in-out;
        }
        .header-icon-button:hover {
            filter: drop-shadow(0 0 5px var(--tg-button)); 
            transform: translateY(-2px); 
        }
        .header-icon-button:active {
            transform: scale(0.95) translateY(0); 
            filter: drop-shadow(0 0 1px var(--tg-hint)); 
        }
        .header-icon-button.active-header-nav { 
            filter: drop-shadow(0 0 5px var(--tg-button));
            color: var(--tg-button); 
            transform: translateY(-1px);
        }
        .header-icon-button .notification-badge {
            position: absolute;
            top: -8px; 
            right: -8px; 
            background-color: var(--notification-badge-bg);
            color: var(--notification-badge-text);
            border-radius: 50%;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
            box-sizing: border-box;
            display: none; 
            border: 1px solid var(--notification-badge-text); 
            animation: pulse 1.5s infinite; 
        }
        
        /* Balance Card Specifics */
        .balance-card h2 { margin: 0 0 10px 0; font-size: 18px; color: var(--tg-hint); } 
        .balance-card .balance-amount { 
            font-size: 42px; 
            color: var(--accent-yellow); 
            text-shadow: 2px 2px 0px var(--pixel-border-dark); 
        }
        
        /* List Styles (Tasks, Withdrawals, Notifications) */
        .list { list-style: none; padding: 0; margin: 0; }
        .list-item { 
            border: 3px solid var(--pixel-border-dark); 
            border-right-color: var(--pixel-border-light); 
            border-bottom-color: var(--pixel-border-light); 
            background: var(--tg-bg); 
            padding: 15px; 
            margin-bottom: 15px; 
            box-shadow: 1px 1px 0px 0px rgba(0,0,0,0.1); 
        }
        .list-item h3 { margin: 0 0 8px 0; font-size: 20px; color: var(--tg-text); } 
        .list-item p { margin: 0 0 12px 0; font-size: 16px; color: var(--tg-hint); }
        
        /* Button Styling */
        .button { 
            padding: 12px; 
            border: 3px solid var(--pixel-border-dark); 
            border-right-color: var(--pixel-border-light); 
            border-bottom-color: var(--pixel-border-light); 
            background: var(--tg-button); 
            color: var(--tg-button-text); 
            font-size: 18px; 
            font-family: 'VT323', monospace; 
            cursor: pointer; 
            text-align: center; 
            text-decoration: none; 
            display: block; 
            width: 100%; 
            box-sizing: border-box;
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            transition: all 0.05s linear; 
        } 
        .button:hover:not(.disabled) {
            filter: brightness(1.1); 
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2); 
        }
        .button:active:not(.disabled) { 
            border-color: var(--pixel-border-light); 
            border-right-color: var(--pixel-border-dark); 
            border-bottom-color: var(--pixel-border-dark); 
            transform: translateY(1px) translateX(1px); 
            box-shadow: none;
        }
        .button.disabled { 
            background-color: var(--tg-hint); 
            cursor: not-allowed; 
            opacity: 0.7; 
            filter: grayscale(0.5); 
        }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; } 
        .stat-card { 
            border: 3px solid var(--pixel-border-dark); 
            border-right-color: var(--pixel-border-light); 
            border-bottom-color: var(--pixel-border-light); 
            background: var(--tg-bg); 
            padding: 15px; 
            text-align: center; 
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.1);
        } 
        .stat-card .value { font-size: 28px; color: var(--accent-yellow); } 
        .stat-card .label { font-size: 16px; color: var(--tg-hint); }
        
        /* Bottom Navigation Bar */
        .bottom-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            display: flex; 
            background: var(--tg-secondary-bg); 
            border-top: 3px solid var(--pixel-border-light); 
            padding: 5px 0; 
            z-index: 100; 
            justify-content: space-around; 
        }
        .nav-item { 
            flex: 1; 
            text-align: center; 
            color: var(--tg-hint); 
            cursor: pointer; 
            padding: 5px 0; 
            transition: color 0.2s;
            max-width: 100px; 
        }
        .nav-item .icon { font-size: 24px; } 
        .nav-item .label { font-size: 12px; }
        .nav-item.active { filter: drop-shadow(0 0 3px var(--tg-button)); color: var(--tg-text); }
        
        /* Loading Overlay */
        .loading-overlay { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 9999; 
            font-size: 24px; 
            color: white; 
            display: none; 
        }
        .loading-overlay::after { 
            content: '';
            display: block;
            width: 32px;
            height: 32px;
            border: 4px solid #fff;
            border-top-color: var(--accent-yellow);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-top: 10px;
            image-rendering: pixelated; 
        }
        
        /* Modal Overlay */
        .modal-overlay { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: none; 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            animation: fadeIn 0.3s forwards;
        }
        .modal-content { 
            border: 3px solid var(--pixel-border-dark); 
            border-right-color: var(--pixel-border-light); 
            border-bottom-color: var(--pixel-border-light); 
            background: var(--tg-secondary-bg); 
            padding: 20px; 
            width: 90%; 
            max-width: 400px; 
            box-sizing: border-box;
            box-shadow: 5px 5px 0px 0px rgba(0,0,0,0.3); 
            animation: fadeIn 0.3s forwards;
            position: relative; 
        }
        .modal-content h2 {
            margin-top: 0;
            font-size: 22px;
            color: var(--tg-text);
            text-align: center;
            margin-bottom: 15px;
        }
        .modal-content .close-button {
            background: none;
            border: none;
            color: var(--tg-hint);
            font-size: 24px;
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
        }
        
        /* Form Group Styling */
        .form-group { margin-bottom: 15px; } 
        .form-group label { display: block; font-size: 18px; margin-bottom: 8px; color: var(--tg-text); } 
        .form-group input, .form-group textarea, .form-group select { 
            width: 100%; 
            padding: 10px; 
            font-size: 18px; 
            font-family: 'VT323', monospace; 
            border: 3px solid var(--pixel-border-dark); 
            background-color: var(--tg-bg); 
            color: var(--tg-text); 
            box-sizing: border-box; 
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.2); 
        }
        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: var(--tg-button); 
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.2), 0 0 5px rgba(66, 165, 245, 0.5); 
        }
        
        /* Toast Notification */
        .toast { 
            position: fixed; 
            bottom: 80px; left: 50%; 
            transform: translateX(-50%); 
            background: var(--tg-secondary-bg); 
            color: var(--tg-text); 
            padding: 15px; 
            z-index: 2000; 
            border: 3px solid var(--pixel-border-light); 
            font-size: 18px; 
            animation: toastIn 0.3s forwards, toastOut 0.3s 2.2s forwards; 
            white-space: nowrap; 
            box-shadow: 3px 3px 0px 0px rgba(0,0,0,0.3);
        }
        
        /* Withdrawal Item Status Colors */
        .withdrawal-item .status { float: right; font-weight: 600; font-size: 16px; } 
        .status-pending { color: var(--accent-yellow); } 
        .status-approved { color: var(--accent-green); } 
        .status-rejected { color: var(--accent-red); }

        /* Notification Specific Styles */
        .notification-item.status-approved {
            background-color: var(--notification-success-bg);
            color: var(--notification-text-color);
            border-color: var(--accent-green);
        }
        .notification-item.status-rejected {
            background-color: var(--notification-danger-bg);
            color: var(--notification-text-color);
            border-color: var(--accent-red);
        }
        .notification-item.status-info { 
            background-color: var(--notification-info-bg);
            color: var(--notification-text-color);
            border-color: var(--tg-button);
        }
        .notification-item h3 {
            color: var(--notification-text-color); 
            text-shadow: 1px 1px 0px rgba(0,0,0,0.3);
        }
        .notification-item p {
            color: rgba(255, 255, 255, 0.8); 
            margin-bottom: 5px;
        }
        .notification-item .reason {
            font-size: 14px;
            font-style: italic;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        .notification-item .date {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }
        .notification-item.unread {
            border-left: 5px solid var(--accent-yellow); 
        }
        
        /* Daily Bonus Card Specifics */
        .daily-bonus-card .progress-bar { 
            height: 10px; 
            background-color: var(--tg-bg); 
            border: 2px solid var(--pixel-border-dark); 
            margin-top: 10px; 
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.2);
        }
        .daily-bonus-card .progress-fill { 
            height: 100%; 
            width: 0%; 
            background-color: var(--accent-green); 
            transition: width 0.5s ease-in-out; 
            box-shadow: inset -1px -1px 0px 0px rgba(0,0,0,0.2);
        }
        
        /* Task Milestone Card Specifics */
        .task-milestone-card .milestone-item { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 16px; }
        .task-milestone-card .milestone-item .reward { color: var(--accent-yellow); }
        .task-milestone-card .milestone-item .claimed { color: var(--accent-green); }
        
        /* Method Selector (GCash/Maya buttons) */
        .method-selector { display: flex; gap: 10px; } 
        .method-selector button { 
            flex-grow: 1; 
            padding: 12px; 
            border: 3px solid var(--pixel-border-dark); 
            background-color: var(--tg-bg); 
            color: var(--tg-text); 
            font-size: 18px; 
            font-family: 'VT323', monospace; 
            cursor: pointer; 
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            transition: all 0.05s linear;
        } 
        .method-selector button.selected { 
            background-color: var(--tg-text); 
            color: var(--tg-bg); 
            border-right-color: var(--pixel-border-dark); 
            border-bottom-color: var(--pixel-border-dark);
            border-left-color: var(--pixel-border-light);
            border-top-color: var(--pixel-border-light);
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.2);
        }
        .method-selector button:active {
            border-color: var(--pixel-border-light);
            border-right-color: var(--pixel-border-dark);
            border-bottom-color: var(--pixel-border-dark);
            transform: translateY(1px) translateX(1px);
        }

        /* Withdrawal Maintenance Overlay */
        .withdrawal-maintenance-overlay { 
            position: absolute; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.8); 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            z-index: 10; 
            color: white; 
            text-align: center; 
            font-size: 20px; 
            display: none; 
        }

        /* Redeem Code UI - Improved */
        .redeem-code-container h3 {
            margin-top: 0;
            margin-bottom: 10px; 
            font-size: 20px;
            color: var(--tg-text); 
            text-align: left; 
        }

        .redeem-code-container p.description {
            font-size: 16px; 
            line-height: 1.5; 
            color: var(--tg-hint); 
            margin-bottom: 15px; 
            text-align: left; 
        }
        
        .redeem-code-input-wrapper {
            display: flex;
            gap: 0; 
            align-items: stretch; 
            margin-top: 0; 
        }

        .pixel-input-recessed {
            flex-grow: 1; 
            margin: 0; 
            padding: 10px; 
            font-size: 18px; 
            font-family: 'VT323', monospace; 
            box-sizing: border-box; 
            background-color: var(--pixel-input-bg); 
            color: var(--pixel-input-text); 
            outline: none; 

            border: 3px solid var(--pixel-border-light); 
            border-right-color: var(--pixel-border-dark); 
            border-bottom-color: var(--pixel-border-dark); 
            
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.2); 
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
        }
        .pixel-input-recessed:focus {
            border-color: var(--tg-button); 
            border-right-color: var(--pixel-border-dark);
            border-bottom-color: var(--pixel-border-dark);
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.2), 0 0 5px rgba(66, 165, 245, 0.5);
        }

        .redeem-code-input-wrapper .button-inline { 
            width: auto; 
            padding: 10px 15px; 
            flex-shrink: 0; 
            display: inline-block; 
            border: 3px solid var(--pixel-border-dark); 
            border-right-color: var(--pixel-border-light); 
            border-bottom-color: var(--pixel-border-light);
            border-left: none; 
            margin-left: -3px; 
            position: relative; 
            z-index: 1; 
            background: var(--tg-button); 
            color: var(--tg-button-text); 
            font-size: 18px; 
            font-family: 'VT323', monospace; 
            cursor: pointer; 
            text-align: center; 
            text-decoration: none;
            box-sizing: border-box;
            -webkit-appearance: none; 
            -moz-appearance: none;
            appearance: none;
            transition: all 0.05s linear;
        }

        .redeem-code-input-wrapper .button-inline:hover:not(.disabled) {
            filter: brightness(1.1);
            box-shadow: 2px 2px 0px 0px rgba(0,0,0,0.2);
        }
        .redeem-code-input-wrapper .button-inline:active:not(.disabled) {
            border-color: var(--pixel-border-light);
            border-right-color: var(--pixel-border-dark);
            border-bottom-color: var(--pixel-border-dark);
            border-left-color: var(--pixel-border-dark); 
            transform: translateY(1px) translateX(1px);
            box-shadow: none;
        }
        
        /* Game Specific Styles */
        .game-room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding: 15px;
            background: var(--tg-bg);
            border: 3px solid var(--pixel-border-dark);
            border-right-color: var(--pixel-border-light);
            border-bottom-color: var(--pixel-border-light);
            box-shadow: 1px 1px 0px 0px rgba(0,0,0,0.1); 
        }
        .game-room-item .game-info {
            flex-grow: 1;
        }
        .game-room-item .game-info h3 {
            margin: 0 0 5px 0;
            color: var(--tg-text);
        }
        .game-room-item .game-info p {
            margin: 0;
            font-size: 14px;
            color: var(--tg-hint);
        }
        .game-room-item .join-button {
            margin-left: 15px;
            width: auto;
            padding: 8px 15px;
            font-size: 16px;
        }
        .game-play-area {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: var(--tg-bg);
            border: 3px solid var(--pixel-border-dark);
            border-right-color: var(--pixel-border-light);
            border-bottom-color: var(--pixel-border-light);
            box-shadow: inset 1px 1px 0px 0px rgba(0,0,0,0.1);
        }
        .game-players {
            display: flex;
            justify-content: space-around;
            align-items: flex-start; 
            margin-bottom: 15px;
            font-size: 22px;
            position: relative;
        }
        .game-player-display {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 120px; 
            padding: 5px;
        }
        .game-player-display.active-player {
            filter: drop-shadow(0 0 3px var(--game-waiting-color)); 
            border: 1px dashed var(--game-waiting-color); 
        }
        .game-player-display .player-name {
            color: var(--game-player-color);
            text-shadow: 1px 1px 0px var(--pixel-border-dark);
            font-size: 18px;
        }
        .game-player-display .opponent-name {
            color: var(--game-opponent-color);
            text-shadow: 1px 1px 0px var(--pixel-border-dark);
            font-size: 18px;
        }
        .game-player-display .move-emoji {
            font-size: 48px;
            min-height: 48px; 
            margin: 5px 0;
        }
        .game-players .vs-text {
            font-size: 18px;
            color: var(--tg-hint);
            margin: 0 10px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .game-stats {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
            font-size: 20px;
            color: var(--tg-text);
            text-shadow: 1px 1px 0px rgba(0,0,0,0.2);
        }
        .game-score {
            color: var(--accent-yellow);
            font-size: 28px;
            margin: 0 5px;
        }

        .game-result-message {
            margin-top: 20px;
            font-size: 24px;
            color: var(--accent-yellow);
            text-shadow: 2px 2px 0px var(--pixel-border-dark);
            min-height: 24px; 
            margin-bottom: 15px;
        }

        .game-play-area .move-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }
        .game-play-area .move-buttons button {
            width: 80px;
            height: 80px;
            font-size: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--tg-secondary-bg);
            color: var(--tg-text);
            border: 3px solid var(--pixel-border-dark);
            border-right-color: var(--pixel-border-light);
            border-bottom-color: var(--pixel-border-light);
        }
        .game-play-area .move-buttons button:hover:not(:disabled) {
            filter: brightness(1.1);
        }
        .game-play-area .move-buttons button:active:not(:disabled) {
            border-color: var(--pixel-border-light);
            border-right-color: var(--pixel-border-dark);
            border-bottom-color: var(--pixel-border-dark);
            transform: translateY(1px) translateX(1px);
        }
        .game-play-area .move-buttons button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }

    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading" class="loading-overlay" style="display: flex;">Loading Xewee...</div>

    <!-- Home View -->
    <div id="homeView" class="app-view active">
        <div class="header"> 
            <div class="app-title-tagline">
                <h1 id="welcome-message">Xewee</h1> 
                <p>Your Pixel Quest for Rewards!</p> 
            </div>
            <div class="top-right-nav">
                <button type="button" id="headerNavNotifications" class="header-icon-button" onclick="showView('notificationsView')">
                    üîî<span id="unreadNotifications" class="notification-badge" style="display:none;">0</span>
                </button>
                <button type="button" id="headerNavProfile" class="header-icon-button" onclick="showView('profileView')">
                    üë§
                </button>
            </div>
        </div>
        <div class="pixel-container balance-card"> <h2>Balance</h2> <p id="balanceAmount" class="balance-amount">P--.--</p> </div>
        <div class="pixel-container daily-bonus-card">
            <h3>Daily Login Bonus</h3>
            <p id="dailyBonusStatus" style="font-size: 16px; margin-bottom: 10px; color: var(--tg-hint);">Loading...</p>
            <div class="progress-bar"><div id="dailyBonusProgress" class="progress-fill"></div></div>
            <button type="button" id="claimDailyBonusBtn" class="button" style="margin-top: 15px;">Claim Bonus (P10.00)</button>
        </div>
        <div class="pixel-container announcement-card"> <h3>Announcements</h3> <p id="announcementText">Loading latest news...</p> </div>
    </div>

    <!-- Tasks View -->
    <div id="tasksView" class="app-view">
        <div class="header"> <h1>Task Board</h1> </div>
        <ul id="taskList" class="list"></ul>
    </div>

    <!-- Referrals View -->
    <div id="referralView" class="app-view">
        <div class="header"> <h1>Recruit Friends</h1> </div>
        <div class="stats-grid">
            <div class="stat-card"> <div id="referralCount" class="value">0</div> <div class="label">Friends Recruited</div> </div>
            <div class="stat-card"> <div id="successfulReferralCount" class="value">0</div> <div class="label">Successful Quests</div> </div>
        </div>
        <br>
        <div class="pixel-container">
            <h3>Your Unique Code</h3>
            <p style="font-size: 16px; line-height: 1.5;">Share this code. For every friend who joins and completes a task, you earn a <strong>10% commission</strong> based on the task's reward!</p>
            <div id="referralLink" style="background: var(--tg-bg); padding: 10px; word-wrap: break-word; font-size: 14px; margin: 15px 0; border: 2px inset var(--pixel-border-dark);"></div>
            <button type="button" id="copyLinkBtn" class="button">Copy Code</button>
        </div>
    </div>
    
    <!-- Gift View -->
    <div id="giftView" class="app-view">
        <div class="header"> <h1>Gift Treasury</h1> </div>
        <div class="pixel-container">
            <h3>Your Gift Tickets</h3>
            <div style="text-align: center; margin-bottom: 20px;">
                <span id="giftTicketCount" style="font-size: 42px; color: var(--accent-yellow);">0</span>
                <p style="color: var(--tg-hint); font-size: 16px; margin-top: 5px;">Tickets Available</p>
            </div>
            <button type="button" id="buyTicketBtn" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark);">Buy Tickets (P10.00)</button>
        </div>
        <div class="pixel-container">
            <h3>Send a Gift</h3>
            <p style="font-size: 16px; line-height: 1.5;">Uses 1 Ticket. A 5% fee applies to the sent amount from your balance. Min: P30.00</p>
            <form id="giftForm">
                <div class="form-group"><label for="giftRecipientId">Recipient User ID</label><input type="number" id="giftRecipientId" placeholder="e.g., 123456789" required></div>
                <div class="form-group"><label for="giftAmount">Amount</label><input type="number" id="giftAmount" placeholder="e.g., 500" required></div>
                <button type="submit" class="button">Send Gift</button>
            </form>
        </div>
    </div>

    <!-- Games View (NEW FEATURE) -->
    <div id="gamesView" class="app-view">
        <div class="header"> <h1>Xewee Games</h1> </div>
        
        <div class="pixel-container">
            <h3>Create Game Room (Jack N Poy)</h3>
            <form id="createGameRoomForm">
                <div class="form-group">
                    <label for="gameBetAmount">Bet Amount</label>
                    <input type="number" id="gameBetAmount" placeholder="e.g., 50.00" min="10" required>
                </div>
                <div class="form-group">
                    <label for="gameRoomName">Room Name (Optional)</label>
                    <input type="text" id="gameRoomName" placeholder="e.g., My RPS Challenge">
                </div>
                <button type="submit" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark);">Create Room</button>
            </form>
            <button type="button" class="button" style="margin-top: 15px; background: var(--tg-hint);" onclick="showGameRulesModal()">View Rules</button>
        </div>

        <div class="pixel-container">
            <h3>Available Rooms</h3>
            <button type="button" id="refreshRoomsBtn" class="button" style="margin-bottom: 15px; background: var(--pixel-border-dark);">Refresh Rooms</button>
            <ul id="availableRoomsList" class="list">
                <!-- Dynamic list of available rooms will be loaded here -->
                <li class="pixel-container"><p>No rooms available. Create one!</p></li>
            </ul>
        </div>

        <div class="pixel-container" id="myActiveGameSection" style="display:none;">
            <h3>My Active Game: <span id="activeGameRoomName"></span></h3>
            <p id="activeGameStatus" style="font-size: 16px; color: var(--game-waiting-color); margin-bottom: 10px;"></p>
            
            <div id="gamePlayArea" style="display:none;">
                <div class="game-players">
                    <div class="game-player-display" id="player1Display">
                        <span class="player-name" id="player1Name"></span>
                        <div class="move-emoji" id="player1Move"></div>
                        <span class="player-score-text">Score: <span id="player1Score">0</span></span>
                    </div>
                    <span class="vs-text">VS</span>
                    <div class="game-player-display" id="player2Display">
                        <span class="opponent-name" id="player2Name"></span>
                        <div class="move-emoji" id="player2Move"></div>
                        <span class="opponent-score-text">Score: <span id="player2Score">0</span></span>
                    </div>
                </div>
                
                <div class="game-result-message" id="gameResultMessage"></div>

                <p id="yourTurnStatus" style="margin-top: 20px; font-size: 18px; color: var(--accent-yellow);"></p>
                <div class="move-buttons">
                    <button type="button" data-move="rock">‚úä</button>
                    <button type="button" data-move="paper">‚úã</button>
                    <button type="button" data-move="scissors">‚úåÔ∏è</button>
                </div>
            </div>
            <button type="button" id="leaveGameBtn" class="button" style="margin-top: 20px; background: var(--accent-red);">Leave Game</button>
        </div>
    </div>


    <!-- Notifications View -->
    <div id="notificationsView" class="app-view">
        <div class="header" style="justify-content: flex-start; gap: 10px; margin-bottom: 20px;"> 
            <h1>Notifications</h1> 
            <button type="button" id="markAllReadBtn" class="button" style="width: auto; padding: 8px 12px; font-size: 16px; margin: 0; background: var(--pixel-border-dark); color: var(--tg-text);">Mark All As Read</button>
        </div>
        <ul id="notificationList" class="list"></ul>
    </div>

    <!-- Profile View -->
    <div id="profileView" class="app-view">
        <div class="header"> <h1>Player Info</h1> </div>
        <div class="pixel-container">
            <p id="profileName" style="font-size: 18px;">Player: ...</p>
            <p id="profileId" style="font-size: 14px; color: var(--tg-hint);">ID: ...</p>
            <p id="tasksCompleted" style="font-size: 14px; color: var(--tg-hint);">Tasks Completed: 0</p>
        </div>
        <div class="pixel-container task-milestone-card">
            <h3>Task Milestones</h3>
            <div id="taskMilestonesList"></div>
        </div>
        <div class="pixel-container redeem-code-container">
            <h3>Redeem Code</h3>
            <p class="description">Enter your special code to claim rewards!</p>
            <div class="redeem-code-input-wrapper">
                <input id="redeemCodeInput" type="text" placeholder="Enter Code" class="pixel-input-recessed">
                <button type="button" id="redeemCodeBtn" class="button-inline">OK</button>
            </div>
        </div>
        <div class="pixel-container" style="position: relative;">
            <div id="withdrawalMaintenanceOverlay" class="withdrawal-maintenance-overlay" style="display:none;">WITHDRAWAL<br>MAINTENANCE</div>
            <h3>Withdraw Funds</h3>
            <p style="font-size: 16px; line-height: 1.5;"><span id="minWithdrawalText">Min: P300.00</span>, <span id="maxWithdrawalText">Max: P30000.00</span></p>
            <form id="withdrawForm">
                <div class="form-group"><label for="withdrawAmount">Amount</label><input type="number" id="withdrawAmount" placeholder="e.g., 500" required></div>
                <div class="form-group"><label>Method</label><div class="method-selector"><button type="button" id="gcashBtn">GCASH</button><button type="button" id="mayaBtn">MAYA</button></div></div>
                <div class="form-group"><label for="withdrawDetails">Account Number</label><input type="tel" id="withdrawDetails" placeholder="Your GCash/Maya number" required></div>
                <p id="withdrawalFeeText" style="font-size: 14px; color: var(--tg-hint); text-align: center; display: none;"></p>
                <button type="submit" class="button" style="background: var(--accent-red); color: var(--tg-button-text); margin-top: 10px;">Submit Withdrawal</button>
            </form>
        </div>
        <div class="pixel-container">
            <h3>Withdrawal History</h3>
            <ul id="withdrawalList" class="list" style="max-height: 150px; overflow-y: auto;"></ul>
        </div>
    </div>

    <!-- Task Submission Modal -->
    <div id="taskModal" class="modal-overlay">
        <div class="modal-content">
            <button type="button" class="close-button" onclick="closeTaskSubmissionModal()">‚úñ</button>
            <h2 id="taskModalTitle" style="font-size: 20px;">Submit Proof</h2>
            <form id="taskProofForm">
                <div class="form-group"><label for="taskProofText">Note (Optional)</label><textarea id="taskProofText" rows="2"></textarea></div>
                <div class="form-group"><label for="taskProofPhoto">Upload Image Proof</label><input type="file" id="taskProofPhoto" accept="image/*" required></div>
                <div style="display: flex; gap: 10px;"><button type="button" id="cancelSubmitBtn" class="button" style="background: var(--tg-hint); flex:1;">Cancel</button><button type="submit" class="button" style="background: var(--accent-green); color: var(--pixel-border-dark); flex:1;">Submit</button></div>
            </form>
        </div>
    </div>

    <!-- Game Rules Modal (NEW) -->
    <div id="gameRulesModal" class="modal-overlay">
        <div class="modal-content">
            <button type="button" class="close-button" onclick="closeGameRulesModal()">‚úñ</button>
            <h2>Jack N Poy Rules</h2>
            <p style="font-size: 16px; margin-bottom: 10px;"><strong>Objective:</strong> Be the first player to reach a score of 3!</p>
            <p style="font-size: 16px; margin-bottom: 10px;"><strong>How to Play:</strong></p>
            <ul style="font-size: 16px; margin-left: 20px; color: var(--tg-text); margin-bottom: 10px;">
                <li>Each player chooses Rock (‚úä), Paper (‚úã), or Scissors (‚úåÔ∏è).</li>
                <li>Rock crushes Scissors (Rock wins).</li>
                <li>Paper covers Rock (Paper wins).</li>
                <li>Scissors cuts Paper (Scissors wins).</li>
                <li>If both players choose the same, it's a draw.</li>
            </ul>
            <p style="font-size: 16px; margin-bottom: 10px;"><strong>Betting:</strong></p>
            <ul style="font-size: 16px; margin-left: 20px; color: var(--tg-text); margin-bottom: 10px;">
                <li>Both players must put up the same bet amount.</li>
                <li>The winner takes the entire pot (double the bet amount).</li>
                <li>If a player leaves the game early, their bet is refunded, and the game is cancelled for both players.</li>
            </ul>
            <button type="button" class="button" style="margin-top: 20px;" onclick="closeGameRulesModal()">Got It!</button>
        </div>
    </div>


    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav">
        <div id="navHome" class="nav-item active" onclick="showView('homeView')"> <div class="icon">üè†</div> <div class="label">Home</div> </div>
        <div id="navTasks" class="nav-item" onclick="showView('tasksView')"> <div class="icon">üìú</div> <div class="label">Tasks</div> </div>
        <div id="navReferral" class="nav-item" onclick="showView('referralView')"> <div class="icon">ü§ù</div> <div class="label">Refer</div> </div>
        <div id="navGift" class="nav-item" onclick="showView('giftView')"> <div class="icon">üéÅ</div> <div class="label">Gift</div> </div>
        <div id="navGames" class="nav-item" onclick="showView('gamesView')"> <div class="icon">üéÆ</div> <div class="label">Games</div> </div>
    </nav>
    
    <!-- Embedded JavaScript Logic -->
    <script>
        // Initialize Telegram WebApp
        const tg = window.Telegram.WebApp; 
        tg.ready(); 
        tg.expand();

        // Dynamically set Telegram theme colors for better integration
        document.documentElement.style.setProperty('--tg-bg', tg.themeParams.bg_color || '#212121');
        document.documentElement.style.setProperty('--tg-text', tg.themeParams.text_color || '#eeeeee');
        document.documentElement.style.setProperty('--tg-hint', tg.themeParams.hint_color || '#9e9e9e');
        document.documentElement.style.setProperty('--tg-button', tg.themeParams.button_color || '#42a5f5');
        document.documentElement.style.setProperty('--tg-button-text', tg.themeParams.button_text_color || '#ffffff');
        document.documentElement.style.setProperty('--tg-secondary-bg', tg.themeParams.secondary_bg_color || '#303030');

        // --- Configuration (UPDATE THESE!) ---
        // Normalize API_BASE_URL to ensure no trailing slash.
        // IMPORTANT: Replace with your Railway backend URL!
        const rawApiBaseUrl = "https://web-production-078c8.up.railway.app"; 
        const API_BASE_URL = rawApiBaseUrl.endsWith('/') ? rawApiBaseUrl.slice(0, -1) : rawApiBaseUrl; 
        
        const BOT_USERNAME = "XeweeBot"; 
        // ------------------------------------

        const user = tg.initDataUnsafe.user;
        const initData = tg.initData;

        let appData = {}; 
        let withdrawalMethod = ''; 
        let activeGameRoomId = null; 
        let gameUpdateInterval = null; 
        
        const TASK_MILESTONES_UI = {10: 50.0, 20: 150.0, 30: 400.0}; 

        // --- Utility Functions (Defined first for scope) ---
        const views = document.querySelectorAll('.app-view');
        const bottomNavItems = document.querySelectorAll('.bottom-nav .nav-item'); 
        const headerNavButtons = document.querySelectorAll('.header-icon-button');

        function showToast(message) { 
            const existingToast = document.querySelector('.toast');
            if(existingToast) existingToast.remove(); 
            const toast = document.createElement('div'); 
            toast.className = 'toast'; 
            toast.innerText = message; 
            document.body.appendChild(toast); 
            setTimeout(() => { 
                toast.remove(); 
            }, 2500); 
        }

        function showGameRulesModal() {
            document.getElementById('gameRulesModal').style.display = 'flex';
        }

        function closeGameRulesModal() {
            document.getElementById('gameRulesModal').style.display = 'none';
        }

        function closeTaskSubmissionModal() {
            document.getElementById('taskModal').style.display = 'none';
            document.getElementById('taskProofForm').reset();
        }

        // --- API Calls Helper Function ---
        async function callApi(endpoint, method = 'POST', body = {}) {
            document.getElementById('loading').style.display = 'flex';
            try {
                const url = `${API_BASE_URL}${endpoint}`;
                const options = {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ user_id: user.id, _auth: initData, ...body })
                };
                console.log(`API Call: ${method} ${url} with body:`, options.body); 
                const response = await fetch(url, options);
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.detail || `Network response was not ok: ${response.status}`);
                }
                return data;
            } catch (error) {
                console.error(`API Call to ${endpoint} error:`, error);
                tg.showAlert(error.message || `An error occurred while calling ${endpoint}.`);
                throw error; 
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // --- UI Rendering Functions (Defined before they are called) ---
        function renderAll(){
            // --- Home View ---
            document.getElementById('balanceAmount').innerText = `P${(appData.balance || 0).toFixed(2)}`;
            document.getElementById('announcementText').innerText = appData.announcement || "Welcome! No new announcements.";
            
            const claimBtn = document.getElementById('claimDailyBonusBtn'); 
            const dailyBonusStatus = document.getElementById('dailyBonusStatus'); 
            const dailyBonusProgress = document.getElementById('dailyBonusProgress');
            const dailyBonusAmount = appData.daily_bonus_amount || 10.0; 

            if (appData.can_claim_daily) { 
                claimBtn.classList.remove('disabled'); 
                claimBtn.innerText = `Claim Bonus (P${dailyBonusAmount.toFixed(2)})`; 
                dailyBonusStatus.innerText = 'Ready to Claim!'; 
                dailyBonusProgress.style.width = '100%'; 
            } else { 
                claimBtn.classList.add('disabled'); 
                const invitesNeeded = Math.max(0, appData.daily_bonus_req - appData.daily_claim_invites); 
                claimBtn.innerText = `Invite ${invitesNeeded} more!`; 
                dailyBonusStatus.innerText = `Invites: ${appData.daily_claim_invites}/${appData.daily_bonus_req} (Needed for tomorrow)`; 
                dailyBonusProgress.style.width = `${(appData.daily_claim_invites / appData.daily_bonus_req) * 100}%`; 
            }

            // --- Tasks View ---
            const taskList = document.getElementById('taskList'); 
            taskList.innerHTML = '';
            if (appData.tasks && appData.tasks.length > 0) { 
                appData.tasks.forEach(task => { 
                    const li = document.createElement('li'); 
                    li.className = 'list-item'; 
                    li.innerHTML = `
                        <h3>${task.description}</h3>
                        <p>REWARD: P${task.reward.toFixed(2)}</p>
                        <div style="display:flex; gap: 10px; margin-top: 15px;">
                            <a href="${task.link}" target="_blank" class="button" style="flex:1;">Visit Link</a>
                            <button type="button" class="button submit-proof-btn" data-task-id="${task.id}" style="flex:1; background: var(--accent-green); color: var(--pixel-border-dark);">Submit Proof</button>
                        </div>
                    `; 
                    taskList.appendChild(li); 
                }); 
            } else { 
                taskList.innerHTML = '<li class="pixel-container"><p>No tasks available. Check back later!</p></li>'; 
            }

            // --- Referrals View ---
            document.getElementById('referralCount').innerText = appData.referral_count || 0;
            document.getElementById('successfulReferralCount').innerText = appData.successful_referrals || 0;
            document.getElementById('referralLink').innerText = `https://t.me/${BOT_USERNAME}?start=${user.id}`;

            // --- Profile View ---
            document.getElementById('profileName').innerText = `Player: ${user.first_name || 'Unknown'}`;
            document.getElementById('profileId').innerText = `ID: ${user.id}`;
            document.getElementById('tasksCompleted').innerText = `Tasks Completed: ${appData.tasks_completed || 0}`;
            
            const milestonesList = document.getElementById('taskMilestonesList'); 
            milestonesList.innerHTML = ''; 
            const claimedMilestones = appData.claimed_milestones || {};
            for (const milestoneKey in TASK_MILESTONES_UI) { 
                const count = parseInt(milestoneKey); 
                const reward = TASK_MILESTONES_UI[milestoneKey]; 
                const backendMilestoneKey = `${count}_tasks`; 
                const isClaimed = claimedMilestones[backendMilestoneKey]; 
                const currentStatus = (appData.tasks_completed >= count) ? (isClaimed ? 'CLAIMED' : 'READY') : 'PENDING'; 
                const statusColor = isClaimed ? 'var(--accent-green)' : (appData.tasks_completed >= count ? 'var(--accent-yellow)' : 'var(--tg-hint)'); 
                const item = document.createElement('div'); 
                item.className = 'milestone-item'; 
                item.innerHTML = `<span>${count} Tasks:</span><span style="color: ${statusColor};">P${reward.toFixed(2)} (${currentStatus})</span>`; 
                milestonesList.appendChild(item); 
            }
            
            document.getElementById('minWithdrawalText').innerText = `Min: P${(appData.min_withdrawal || 300).toFixed(2)}`;
            document.getElementById('maxWithdrawalText').innerText = `Max: P${(appData.max_withdrawal || 30000).toFixed(2)}`;
            
            const withdrawalList = document.getElementById('withdrawalList'); 
            withdrawalList.innerHTML = '';
            if (appData.withdrawals && appData.withdrawals.length > 0) { 
                appData.withdrawals.forEach(w => { 
                    const item = document.createElement('li'); 
                    item.className = 'list-item withdrawal-item'; 
                    item.innerHTML = `<span>P${w.amount.toFixed(2)} (${w.method}) on ${w.date}</span><span class="status status-${w.status}">${w.status.toUpperCase()}</span>`; 
                    withdrawalList.appendChild(item); 
                }); 
            } else { 
                withdrawalList.innerHTML = '<li class="pixel-container"><p>No withdrawal history.</p></li>'; 
            }
            
            if (appData.withdrawal_maintenance) { 
                document.getElementById('withdrawalMaintenanceOverlay').style.display = 'flex'; 
            } else { 
                document.getElementById('withdrawalMaintenanceOverlay').style.display = 'none'; 
            }

            // --- Gift View ---
            document.getElementById('giftTicketCount').innerText = appData.gift_tickets || 0;
            document.getElementById('buyTicketBtn').innerText = `Buy Tickets (P${(appData.gift_ticket_price || 10.00).toFixed(2)})`;
            document.querySelector('#giftView .pixel-container p').innerHTML = `Uses 1 Ticket. A ${((appData.gift_fee_percent || 0.05)*100).toFixed(0)}% fee applies to the sent amount from your balance. Min: P${(appData.gift_min_amount || 30.00).toFixed(2)}`;

            // Initial fetch for notifications when app data is loaded
            fetchNotifications();

            // Handle active game state display after initial data loads
            if (appData.active_game_room_id) {
                activeGameRoomId = appData.active_game_room_id;
                document.getElementById('myActiveGameSection').style.display = 'block';
                document.getElementById('activeGameRoomName').innerText = appData.active_game_room_name || `Room ${activeGameRoomId}`;
                document.getElementById('activeGameStatus').innerText = `Room: ${appData.active_game_room_name || activeGameRoomId} - Game in progress!`; // Initial status text
                document.getElementById('gamePlayArea').style.display = 'block';
                startGamePolling(activeGameRoomId);
            } else {
                activeGameRoomId = null;
                document.getElementById('myActiveGameSection').style.display = 'none';
                document.getElementById('gamePlayArea').style.display = 'none';
                stopGamePolling();
            }
        }

        function renderNotifications(notifications) {
            const notificationList = document.getElementById('notificationList');
            notificationList.innerHTML = ''; 

            if (!notifications || notifications.length === 0) {
                notificationList.innerHTML = '<li class="pixel-container"><p>No new notifications.</p></li>';
                return;
            }

            notifications.forEach(notif => {
                const li = document.createElement('li');
                let statusClass = `status-${notif.status}`;
                if (notif.type === 'referral_join' || notif.type === 'gift_received' || notif.type.startsWith('game_')) {
                    statusClass = 'status-info'; // Use info style for these types
                }
                li.className = `list-item notification-item ${statusClass} ${notif.is_read ? '' : 'unread'}`;
                
                let detailsHtml = '';
                let title = '';

                if (notif.type === 'task_submission') {
                    title = `Task: ${notif.description}`;
                    detailsHtml = `
                        <p>Reward: P${notif.reward.toFixed(2)}</p>
                    `;
                } else if (notif.type === 'withdrawal') {
                    title = `Withdrawal: P${notif.amount.toFixed(2)}`;
                    detailsHtml = `
                        <p>Method: ${notif.method}</p>
                    `;
                } else if (notif.type === 'referral_join') {
                    title = `New Friend Joined!`;
                    detailsHtml = `
                        <p>${notif.message}</p> <!-- Message from backend now has full text -->
                    `;
                } else if (notif.type === 'gift_received') {
                    title = `Gift Received!`;
                    detailsHtml = `
                        <p>${notif.message}</p>
                    `;
                } else if (notif.type === 'game_won' || notif.type === 'game_lost') {
                    title = notif.type === 'game_won' ? 'Game Won!' : 'Game Lost!';
                    detailsHtml = `<p>${notif.message}</p>`;
                }


                if (notif.status === 'rejected' && notif.reason) {
                    detailsHtml += `<p class="reason">Reason: ${notif.reason}</p>`;
                }
                
                li.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <h3>${title}</h3>
                            ${detailsHtml}
                            <div class="date">${new Date(notif.date).toLocaleDateString()}</div>
                        </div>
                        <span class="status ${statusClass}" style="flex-shrink: 0; margin-left: 10px;">${notif.status.toUpperCase()}</span>
                    </div>
                `;
                notificationList.appendChild(li);
            });
        }
        
        // --- Primary Data Fetching Functions ---
        async function fetchInitialDataAndRender() {
            try {
                appData = await callApi('/get_initial_data', 'POST', {});
                activeGameRoomId = appData.active_game_room_id; // Update active game status
                renderAll(); 
            } catch (error) { 
                tg.showAlert(error.message || 'COULD NOT LOAD DATA. PLEASE RESTART.'); 
            }
        }


        // --- Navigation Logic (Centralized) ---
        function showView(viewId) { 
            tg.HapticFeedback.impactOccurred('light'); 
            
            views.forEach(v => v.classList.remove('active')); 
            document.getElementById(viewId).classList.add('active'); 
            
            bottomNavItems.forEach(n => n.classList.remove('active')); 
            headerNavButtons.forEach(btn => btn.classList.remove('active-header-nav')); 

            const currentBottomNavItem = document.getElementById(`nav${viewId.replace('View', '')}`);
            if (currentBottomNavItem) {
                currentBottomNavItem.classList.add('active'); 
            } else if (viewId === 'notificationsView') {
                document.getElementById('headerNavNotifications').classList.add('active-header-nav');
            } else if (viewId === 'profileView') {
                document.getElementById('headerNavProfile').classList.add('active-header-nav');
            }

            if (viewId === 'notificationsView') {
                fetchNotifications();
            } else if (viewId === 'homeView' || viewId === 'profileView') {
                fetchInitialDataAndRender(); // Re-fetch to ensure fresh data
            } else if (viewId === 'gamesView') {
                fetchAvailableRooms();
                if (activeGameRoomId) {
                    document.getElementById('myActiveGameSection').style.display = 'block';
                    document.getElementById('gamePlayArea').style.display = 'block'; 
                    startGamePolling(activeGameRoomId);
                } else {
                    document.getElementById('myActiveGameSection').style.display = 'none';
                    document.getElementById('gamePlayArea').style.display = 'none'; 
                    stopGamePolling();
                }
            } else {
                stopGamePolling(); 
            }
        }


        // --- Game Logic Functions ---
        async function createGameRoom() {
            const betAmount = parseFloat(document.getElementById('gameBetAmount').value);
            const roomName = document.getElementById('gameRoomName').value.trim();

            if (isNaN(betAmount) || betAmount <= 0) {
                tg.showAlert('Please enter a valid bet amount.');
                return;
            }
            if (betAmount > appData.balance) {
                tg.showAlert('Insufficient balance to create this room.');
                return;
            }

            try {
                const result = await callApi('/games/create_room', 'POST', { bet_amount: betAmount, room_name: roomName });
                tg.showAlert(`Game room "${result.room_name}" created! Waiting for opponent.`);
                activeGameRoomId = result.room_id;
                document.getElementById('createGameRoomForm').reset();
                document.getElementById('myActiveGameSection').style.display = 'block';
                document.getElementById('activeGameRoomName').innerText = result.room_name;
                document.getElementById('activeGameStatus').innerText = `Room: ${result.room_name} - Waiting for opponent... (Bet: P${result.bet_amount.toFixed(2)})`;
                document.getElementById('gamePlayArea').style.display = 'none'; 
                startGamePolling(activeGameRoomId);
                fetchInitialDataAndRender(); 
                fetchAvailableRooms(); 
            } catch (error) {
                console.error("Create room error:", error);
            }
        }

        async function fetchAvailableRooms() {
            try {
                const rooms = await callApi('/games/list_rooms', 'POST', {});
                renderAvailableRooms(rooms);
            } catch (error) {
                console.error("Fetch available rooms error:", error);
            }
        }

        function renderAvailableRooms(rooms) {
            const availableRoomsList = document.getElementById('availableRoomsList');
            availableRoomsList.innerHTML = '';

            const roomsToShow = rooms.filter(room => room.creator_id !== user.id);

            if (!roomsToShow || roomsToShow.length === 0) {
                availableRoomsList.innerHTML = '<li class="pixel-container"><p>No rooms available. Create one!</p></li>';
                return;
            }

            roomsToShow.forEach(room => {
                const li = document.createElement('li');
                li.className = 'list-item game-room-item';
                li.innerHTML = `
                    <div class="game-info">
                        <h3>${room.room_name || `Room ID: ${room.room_id}`}</h3>
                        <p>Bet: P${room.bet_amount.toFixed(2)}</p>
                        <p>Creator: ${room.creator_name}</p>
                    </div>
                    <button type="button" class="button join-button" data-room-id="${room.room_id}" style="background: var(--accent-yellow); color: var(--pixel-border-dark);">Join</button>
                `;
                availableRoomsList.appendChild(li);
            });

            availableRoomsList.querySelectorAll('.join-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    const roomId = e.target.dataset.roomId;
                    joinGameRoom(roomId);
                });
            });
        }

        async function joinGameRoom(roomId) {
            try {
                const result = await callApi('/games/join_room', 'POST', { room_id: roomId });
                tg.showAlert(`Joined room "${result.room_name}"!`);
                activeGameRoomId = result.room_id;
                document.getElementById('myActiveGameSection').style.display = 'block';
                document.getElementById('activeGameRoomName').innerText = result.room_name;
                document.getElementById('activeGameStatus').innerText = `Room: ${result.room_name} - Game Started! (Bet: P${result.bet_amount.toFixed(2)})`;
                document.getElementById('gamePlayArea').style.display = 'block'; 
                startGamePolling(activeGameRoomId);
                fetchInitialDataAndRender(); 
                fetchAvailableRooms(); 
            } catch (error) {
                console.error("Join room error:", error);
            }
        }

        async function makeGameMove(move) {
            if (!activeGameRoomId) {
                tg.showAlert('You are not in an active game.');
                return;
            }
            // Disable buttons temporarily to prevent double click
            document.querySelectorAll('#gamePlayArea .move-buttons button').forEach(btn => btn.disabled = true);
            
            try {
                const result = await callApi('/games/make_move', 'POST', { room_id: activeGameRoomId, move: move });
                tg.HapticFeedback.impactOccurred('medium');
                showToast(`You chose ${move.toUpperCase()}!`);
                updateGameUI(result); 
            } catch (error) {
                // Error handled by callApi, re-enable buttons on error or on next poll
                document.querySelectorAll('#gamePlayArea .move-buttons button').forEach(btn => btn.disabled = false); 
                console.error("Make move error:", error);
            }
        }

        async function leaveGame() {
            if (!activeGameRoomId) {
                tg.showAlert('You are not in an active game.');
                return;
            }
            tg.showConfirm('Are you sure you want to leave this game? Your bet will be refunded, and the game will be cancelled for both players.', async (ok) => {
                if (ok) {
                    try {
                        await callApi('/games/leave_room', 'POST', { room_id: activeGameRoomId });
                        tg.showAlert('You have left the game.');
                        activeGameRoomId = null;
                        document.getElementById('myActiveGameSection').style.display = 'none';
                        document.getElementById('gamePlayArea').style.display = 'none';
                        stopGamePolling();
                        fetchAvailableRooms(); 
                        fetchInitialDataAndRender(); 
                    } catch (error) {
                        console.error("Leave game error:", error);
                    }
                }
            });
        }

        async function fetchGameStatus() {
            if (!activeGameRoomId) {
                stopGamePolling();
                return;
            }
            try {
                const gameData = await callApi('/games/get_game_state', 'POST', { room_id: activeGameRoomId });
                updateGameUI(gameData);
            } catch (error) {
                if (error.message && (error.message.includes("Game ended") || error.message.includes("not found") || error.message.includes("cancelled"))) {
                    activeGameRoomId = null;
                    stopGamePolling();
                    document.getElementById('myActiveGameSection').style.display = 'none';
                    document.getElementById('gamePlayArea').style.display = 'none';
                    fetchAvailableRooms();
                    fetchInitialDataAndRender();
                    tg.showAlert(error.message); 
                }
                console.error("Fetch game status error:", error);
            }
        }

        const MOVE_EMOJIS = {
            'rock': '‚úä',
            'paper': '‚úã',
            'scissors': '‚úåÔ∏è',
            'none': '' 
        };

        function updateGameUI(gameData) {
            const statusElement = document.getElementById('activeGameStatus');
            const gamePlayArea = document.getElementById('gamePlayArea');
            const player1Display = document.getElementById('player1Display');
            const player2Display = document.getElementById('player2Display');
            const player1NameElement = document.getElementById('player1Name');
            const player2NameElement = document.getElementById('player2Name');
            const player1ScoreElement = document.getElementById('player1Score');
            const player2ScoreElement = document.getElementById('player2Score');
            const player1MoveElement = document.getElementById('player1Move');
            const player2MoveElement = document.getElementById('player2Move');
            const gameResultMessageElement = document.getElementById('gameResultMessage');
            const yourTurnStatus = document.getElementById('yourTurnStatus');
            const moveButtons = document.querySelectorAll('#gamePlayArea .move-buttons button');

            const isCreator = (gameData.creator_id === user.id);
            
            player1NameElement.innerText = user.first_name || 'You';
            player2NameElement.innerText = gameData.opponent_name || 'Opponent';

            player1ScoreElement.innerText = isCreator ? gameData.creator_score : gameData.opponent_score;
            player2ScoreElement.innerText = isCreator ? gameData.opponent_score : gameData.creator_score;

            const currentPlayerLastMove = isCreator ? gameData.creator_last_move : gameData.opponent_last_move;
            const opponentPlayerLastMove = isCreator ? gameData.opponent_last_move : gameData.creator_last_move;
            
            player1MoveElement.innerText = MOVE_EMOJIS[currentPlayerLastMove] || '';
            player2MoveElement.innerText = MOVE_EMOJIS[opponentPlayerLastMove] || '';


            if (gameData.status === 'waiting_for_opponent') {
                statusElement.innerText = `Room: ${gameData.room_name} - Waiting for opponent... (Bet: P${gameData.bet_amount.toFixed(2)})`;
                gamePlayArea.style.display = 'none';
                yourTurnStatus.innerText = "Waiting for an opponent to join...";
                moveButtons.forEach(btn => btn.disabled = true);
                player1Display.classList.remove('active-player');
                player2Display.classList.remove('active-player');
            } else if (gameData.status === 'in_progress') {
                statusElement.innerText = `Room: ${gameData.room_name} - Game in progress! (Bet: P${gameData.bet_amount.toFixed(2)})`;
                gamePlayArea.style.display = 'block';

                const playerMoved = gameData.player_move_made;
                const opponentMoved = gameData.opponent_move_made;
                
                if (!playerMoved) { 
                    yourTurnStatus.innerText = "Make your move!";
                    moveButtons.forEach(btn => btn.disabled = false);
                    player1Display.classList.add('active-player');
                    player2Display.classList.remove('active-player');
                } else if (playerMoved && !opponentMoved) { 
                    yourTurnStatus.innerText = "Waiting for opponent's move...";
                    moveButtons.forEach(btn => btn.disabled = true);
                    player1Display.classList.remove('active-player');
                    player2Display.classList.add('active-player');
                } else { 
                    yourTurnStatus.innerText = gameData.last_round_result || "Waiting for next round...";
                    moveButtons.forEach(btn => btn.disabled = true); 
                    player1Display.classList.remove('active-player');
                    player2Display.classList.remove('active-player');
                    player1MoveElement.innerText = ''; // Reset for next round
                    player2MoveElement.innerText = ''; // Reset for next round
                }

                gameResultMessageElement.innerText = gameData.last_round_result || "";

            } else if (gameData.status === 'finished' || gameData.status === 'cancelled') {
                statusElement.innerText = `Game Over!`;
                gamePlayArea.style.display = 'block'; 
                
                player1MoveElement.innerText = MOVE_EMOJIS[currentPlayerLastMove] || '';
                player2MoveElement.innerText = MOVE_EMOJIS[opponentPlayerLastMove] || '';
                
                player1ScoreElement.innerText = isCreator ? gameData.creator_score : gameData.opponent_score;
                player2ScoreElement.innerText = isCreator ? gameData.opponent_score : gameData.creator_score;
                gameResultMessageElement.innerText = gameData.final_result_message;
                yourTurnStatus.innerText = ""; 
                moveButtons.forEach(btn => btn.disabled = true); 
                player1Display.classList.remove('active-player');
                player2Display.classList.remove('active-player');

                activeGameRoomId = null; 
                stopGamePolling();
                document.getElementById('myActiveGameSection').style.display = 'none';
                fetchAvailableRooms();
                fetchInitialDataAndRender();
            }
        }

        function startGamePolling(roomId) {
            stopGamePolling(); 
            gameUpdateInterval = setInterval(() => fetchGameStatus(roomId), 3000); 
        }

        function stopGamePolling() {
            if (gameUpdateInterval) {
                clearInterval(gameUpdateInterval);
                gameUpdateInterval = null;
            }
        }

        // --- Event Listeners ---
        window.addEventListener('load', fetchInitialDataAndRender); // Changed to call the main rendering function

        if (user && user.first_name) {
             document.getElementById('welcome-message').innerText = `Hey, ${user.first_name}!`;
        }

        document.getElementById('copyLinkBtn').addEventListener('click', () => { 
            navigator.clipboard.writeText(document.getElementById('referralLink').innerText).then(() => { 
                tg.HapticFeedback.notificationOccurred('success'); 
                showToast('Link Copied!'); 
            }).catch(err => {
                console.error("Failed to copy text: ", err);
                tg.showAlert("Failed to copy link. Please try manually.");
            }); 
        });

        document.getElementById('claimDailyBonusBtn').addEventListener('click', async () => { 
            if (document.getElementById('claimDailyBonusBtn').classList.contains('disabled')) { 
                tg.showAlert("You must meet the invite requirements or wait until tomorrow to claim."); 
                return; 
            } 
            try { 
                await callApi('/claim_daily_bonus', 'POST', {});
                tg.showAlert(`P${(appData.daily_bonus_amount || 10.0).toFixed(2)} has been added to your balance!`); 
                fetchInitialDataAndRender(); 
            } catch (error) { 
                console.error("Claim daily bonus error:", error);
            } 
        });

        const taskModal = document.getElementById('taskModal'); 
        let currentTaskId = null; 

        document.getElementById('taskList').addEventListener('click', e => { 
            if (e.target.classList.contains('submit-proof-btn')) { 
                openTaskModal(e.target.getAttribute('data-task-id')); 
            }
        });

        function openTaskModal(taskId) { 
            currentTaskId = taskId; 
            taskModal.style.display = 'flex'; 
        }

        document.getElementById('cancelSubmitBtn').addEventListener('click', () => { 
            closeTaskSubmissionModal();
        });

        taskModal.addEventListener('click', (e) => { 
            if (e.target === taskModal) {
                closeTaskSubmissionModal();
            }
        });

        document.getElementById('taskProofForm').addEventListener('submit', async function(e) { 
            e.preventDefault(); 
            const text = document.getElementById('taskProofText').value; 
            const photoInput = document.getElementById('taskProofPhoto'); 
            
            if (photoInput.files.length === 0) { 
                tg.showAlert('Please upload a screenshot.'); 
                return; 
            } 

            const reader = new FileReader(); 
            reader.readAsDataURL(photoInput.files[0]); 
            
            reader.onload = async () => { 
                try { 
                    await callApi('/submit_task_proof', 'POST', { task_id: currentTaskId, text, photo: reader.result });
                    tg.showAlert('Proof submitted for review!'); 
                    closeTaskSubmissionModal(); 
                    fetchInitialDataAndRender(); 
                } catch (error) { 
                    console.error("Task submission error:", error);
                } 
            }; 
            reader.onerror = () => { 
                console.error("Error reading file:", reader.error);
                tg.showAlert('Error reading file.'); 
            }; 
        });

        document.getElementById('redeemCodeBtn').addEventListener('click', async () => { 
            const code = document.getElementById('redeemCodeInput').value.trim(); 
            if (!code) { 
                showToast('Please enter a code.');
                return; 
            } 
            try { 
                const result = await callApi('/redeem_code', 'POST', { code: code });
                tg.showAlert(`Success! P${result.amount_rewarded.toFixed(2)} added to your balance.`); 
                document.getElementById('redeemCodeInput').value = ''; 
                fetchInitialDataAndRender(); 
            } catch (error) { 
                console.error("Redeem code error:", error);
            } 
        });

        document.getElementById('gcashBtn').addEventListener('click', () => { 
            withdrawalMethod = 'GCash'; 
            document.getElementById('gcashBtn').classList.add('selected'); 
            document.getElementById('mayaBtn').classList.remove('selected'); 
            document.getElementById('withdrawDetails').placeholder = "Your GCash number";
        }); 
        document.getElementById('mayaBtn').addEventListener('click', () => { 
            withdrawalMethod = 'Maya'; 
            document.getElementById('mayaBtn').classList.add('selected'); 
            document.getElementById('gcashBtn').classList.remove('selected'); 
            document.getElementById('withdrawDetails').placeholder = "Your Maya number";
        });

        document.getElementById('withdrawForm').addEventListener('submit', async function(e) { 
            e.preventDefault(); 
            if (appData.withdrawal_maintenance) { 
                tg.showAlert("Withdrawals are currently under maintenance. Please try again later."); 
                return; 
            } 
            const amount = parseFloat(document.getElementById('withdrawAmount').value); 
            const details = document.getElementById('withdrawDetails').value.trim(); 
            
            const minWithdrawal = appData.min_withdrawal || 300;
            const maxWithdrawal = appData.max_withdrawal || 30000;
            const withdrawalFeePercent = appData.withdrawal_fee_percent || 0.03;

            const fee = amount * withdrawalFeePercent; 
            const totalDeduction = amount + fee; 

            if (isNaN(amount) || amount < minWithdrawal || amount > maxWithdrawal) { 
                tg.showAlert(`Amount must be between P${minWithdrawal.toFixed(2)} and P${maxWithdrawal.toFixed(2)}.`); 
                return; 
            } 
            if (totalDeduction > appData.balance) { 
                tg.showAlert('Insufficient balance to cover amount and fee.'); 
                return; 
            } 
            if (!withdrawalMethod) { 
                tg.showAlert('Please select a withdrawal method (GCash or Maya).'); 
                return; 
            } 
            if (!details) { 
                tg.showAlert('Please enter your account number.'); 
                return; 
            } 
            
            try { 
                await callApi('/submit_withdrawal', 'POST', { amount, method: withdrawalMethod, details });
                tg.showAlert('Withdrawal request submitted!'); 
                fetchInitialDataAndRender(); 
                document.getElementById('withdrawForm').reset(); 
                withdrawalMethod = ''; 
                document.getElementById('gcashBtn').classList.remove('selected'); 
                document.getElementById('mayaBtn').classList.remove('selected'); 
                document.getElementById('withdrawalFeeText').style.display = 'none'; 
            } catch (error) { 
                console.error("Submit withdrawal error:", error);
            } 
        });

        document.getElementById('withdrawAmount').addEventListener('input', (e) => { 
            const amount = parseFloat(e.target.value) || 0; 
            const fee = amount * (appData.withdrawal_fee_percent || 0.03); 
            const feeText = document.getElementById('withdrawalFeeText'); 
            if(amount > 0) { 
                feeText.innerText = `Fee: P${fee.toFixed(2)} | Total to deduct: P${(amount + fee).toFixed(2)}`; 
                feeText.style.display = 'block'; 
            } else { 
                feeText.style.display = 'none'; 
            } 
        });

        document.getElementById('buyTicketBtn').addEventListener('click', async () => { 
            const giftTicketPrice = appData.gift_ticket_price || 10.00; 
            tg.showConfirm(`Buy 1 Gift Ticket for P${giftTicketPrice.toFixed(2)}?`, async (ok) => { 
                if(ok){ 
                    try { 
                        await callApi('/buy_ticket', 'POST', {});
                        tg.showAlert("Success! You received 1 Gift Ticket."); 
                        fetchInitialDataAndRender(); 
                    } catch(e) { 
                        console.error("Buy ticket error:", e);
                    } 
                } 
            }); 
        });

        document.getElementById('giftForm').addEventListener('submit', async function(e) { 
            e.preventDefault(); 
            const recipient_id = document.getElementById('giftRecipientId').value.trim(); 
            const amount = parseFloat(document.getElementById('giftAmount').value); 
            
            const giftMinAmount = appData.gift_min_amount || 30.00; 
            const giftMaxAmount = appData.gift_max_amount || 80000;
            const giftFeePercent = appData.gift_fee_percent || 0.05;

            if(!recipient_id || isNaN(amount)) { 
                tg.showAlert("Please fill all fields correctly."); 
                return; 
            } 
            if(appData.gift_tickets < 1) { 
                tg.showAlert("You do not have any Gift Tickets to use."); 
                return; 
            } 
            if(amount < giftMinAmount || amount > giftMaxAmount) {
                tg.showAlert(`Gift amount must be between P${giftMinAmount.toFixed(2)} and P${giftMaxAmount.toFixed(2)}.`);
                return;
            }

            try { 
                await callApi('/gift_money', 'POST', { recipient_id: parseInt(recipient_id), amount });
                tg.showAlert("Gift sent successfully!"); 
                fetchInitialDataAndRender(); 
                document.getElementById('giftForm').reset(); 
            } catch(e) { 
                console.error("Send gift error:", e);
            } 
        });

        document.getElementById('createGameRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            createGameRoom();
        });

        document.getElementById('refreshRoomsBtn').addEventListener('click', fetchAvailableRooms);
        document.getElementById('leaveGameBtn').addEventListener('click', leaveGame);

        document.querySelectorAll('#gamePlayArea .move-buttons button').forEach(button => {
            button.addEventListener('click', (e) => {
                makeGameMove(e.target.dataset.move);
            });
        });

        document.getElementById('markAllReadBtn').addEventListener('click', markAllNotificationsAsRead);

    </script>
</body>
</html>